<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>منصة عين التعليمية - الطالب</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
    <style>
        :root {
            --primary: #2c5aa0;
            --primary-light: #4a7bc1;
            --primary-dark: #1d3d6f;
            --secondary: #00a896;
            --secondary-light: #02c39a;
            --accent: #ff6b6b;
            --light: #f8f9fa;
            --dark: #343a40;
            --gray: #6c757d;
            --gray-light: #e9ecef;
            --border-radius: 12px;
            --box-shadow: 0 6px 15px rgba(0, 0, 0, 0.08);
            --transition: all 0.3s ease;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        body {
            background: linear-gradient(135deg, #f5f7fb 0%, #e9f2ff 100%);
            color: var(--dark);
            line-height: 1.6;
            min-height: 100vh;
        }

        .header {
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
            color: white;
            padding: 35px 20px;
            text-align: center;
            box-shadow: var(--box-shadow);
            position: relative;
            overflow: hidden;
        }

        .header::before {
            content: "";
            position: absolute;
            top: -50%;
            right: -20%;
            width: 150%;
            height: 150%;
            background: rgba(255, 255, 255, 0.05);
            transform: rotate(30deg);
        }

        .header .logo {
            font-size: 32px;
            font-weight: 800;
            margin-bottom: 15px;
            position: relative;
            z-index: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 15px;
        }

        .header .logo i {
            color: var(--secondary-light);
            font-size: 36px;
        }

        .header .tagline {
            font-size: 18px;
            opacity: 0.95;
            max-width: 700px;
            margin: 0 auto;
            position: relative;
            z-index: 1;
            line-height: 1.8;
        }

        .container {
            max-width: 800px;
            margin: 30px auto;
            padding: 0 20px;
        }

        .form-card {
            background-color: white;
            border-radius: var(--border-radius);
            box-shadow: var(--box-shadow);
            padding: 35px;
            margin-bottom: 30px;
            transition: var(--transition);
            border: 1px solid rgba(44, 90, 160, 0.1);
        }

        .form-card:hover {
            box-shadow: 0 12px 25px rgba(0, 0, 0, 0.12);
            transform: translateY(-5px);
        }

        .form-card h2 {
            color: var(--primary);
            margin-bottom: 10px;
            font-size: 26px;
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .form-card h2 i {
            color: var(--secondary);
        }

        .form-card .form-subtitle {
            color: var(--gray);
            margin-bottom: 30px;
            font-size: 16px;
            line-height: 1.6;
        }

        .form-group {
            margin-bottom: 25px;
        }

        .form-group label {
            display: block;
            margin-bottom: 10px;
            font-weight: 600;
            color: var(--dark);
            font-size: 15px;
        }

        .form-group .input-with-icon {
            position: relative;
        }

        .form-group .input-with-icon i {
            position: absolute;
            right: 15px;
            top: 50%;
            transform: translateY(-50%);
            color: var(--gray);
        }

        .form-group input,
        .form-group textarea,
        .form-group select {
            width: 100%;
            padding: 16px 50px 16px 16px;
            border: 2px solid var(--gray-light);
            border-radius: var(--border-radius);
            font-size: 16px;
            transition: var(--transition);
            background-color: #fdfdfd;
        }

        .form-group input:focus,
        .form-group textarea:focus,
        .form-group select:focus {
            outline: none;
            border-color: var(--primary-light);
            background-color: white;
            box-shadow: 0 0 0 3px rgba(44, 90, 160, 0.1);
        }

        .form-group input.error,
        .form-group textarea.error {
            border-color: var(--accent);
        }

        .form-group .error-message {
            color: var(--accent);
            font-size: 14px;
            margin-top: 8px;
            display: none;
        }

        .form-group .char-count {
            font-size: 14px;
            color: var(--gray);
            text-align: left;
            margin-top: 8px;
        }

        .form-group .char-count.warning {
            color: #e74c3c;
            font-weight: 600;
        }

        .form-group select {
            cursor: pointer;
            appearance: none;
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='16' height='16' fill='%236c757d' viewBox='0 0 16 16'%3E%3Cpath d='M7.247 11.14 2.451 5.658C1.885 5.013 2.345 4 3.204 4h9.592a1 1 0 0 1 .753 1.659l-4.796 5.48a1 1 0 0 1-1.506 0z'/%3E%3C/svg%3E");
            background-repeat: no-repeat;
            background-position: left 15px center;
            padding-left: 40px;
        }

        .submit-btn {
            background: linear-gradient(135deg, var(--secondary) 0%, var(--secondary-light) 100%);
            color: white;
            border: none;
            padding: 18px 30px;
            border-radius: var(--border-radius);
            font-size: 18px;
            font-weight: 700;
            cursor: pointer;
            transition: var(--transition);
            width: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 12px;
            margin-top: 15px;
        }

        .submit-btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 10px 20px rgba(0, 168, 150, 0.25);
        }

        .submit-btn:active {
            transform: translateY(0);
        }

        .submit-btn:disabled {
            background: var(--gray-light);
            color: var(--gray);
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        .privacy-notice {
            background: linear-gradient(135deg, rgba(44, 90, 160, 0.05) 0%, rgba(44, 90, 160, 0.02) 100%);
            border-radius: var(--border-radius);
            padding: 25px;
            margin-top: 35px;
            border-right: 4px solid var(--primary);
        }

        .privacy-notice h4 {
            color: var(--primary);
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 12px;
            font-size: 18px;
        }

        .privacy-notice p {
            color: var(--gray);
            font-size: 15px;
            line-height: 1.8;
        }

        .login-container {
            display: none;
        }

        .login-container.active {
            display: block;
        }

        .login-card {
            background-color: white;
            border-radius: var(--border-radius);
            box-shadow: var(--box-shadow);
            padding: 40px;
            max-width: 500px;
            margin: 50px auto;
            border: 1px solid rgba(44, 90, 160, 0.1);
        }

        .login-tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 30px;
            border-bottom: 2px solid var(--gray-light);
            padding-bottom: 10px;
        }

        .login-tab {
            flex: 1;
            padding: 15px;
            background: none;
            border: none;
            border-bottom: 3px solid transparent;
            cursor: pointer;
            font-weight: 600;
            color: var(--gray);
            transition: var(--transition);
            font-size: 16px;
        }

        .login-tab.active {
            color: var(--primary);
            border-bottom-color: var(--primary);
        }

        .login-form {
            display: none;
        }

        .login-form.active {
            display: block;
        }

        .login-form h3 {
            color: var(--primary);
            margin-bottom: 25px;
            text-align: center;
            font-size: 24px;
        }

        .student-dashboard {
            display: none;
        }

        .student-dashboard.active {
            display: block;
        }

        .user-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 2px solid var(--gray-light);
        }

        .user-info {
            display: flex;
            align-items: center;
            gap: 20px;
        }

        .user-avatar {
            width: 60px;
            height: 60px;
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-light) 100%);
            color: white;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            font-weight: 700;
            box-shadow: 0 4px 10px rgba(44, 90, 160, 0.2);
        }

        .user-details h3 {
            color: var(--primary);
            margin-bottom: 5px;
            font-size: 20px;
        }

        .user-details p {
            color: var(--gray);
            font-size: 14px;
        }

        .logout-btn {
            background: linear-gradient(135deg, rgba(255, 107, 107, 0.1) 0%, rgba(255, 107, 107, 0.05) 100%);
            color: var(--accent);
            border: 2px solid var(--accent);
            padding: 12px 25px;
            border-radius: 30px;
            cursor: pointer;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 10px;
            transition: var(--transition);
        }

        .logout-btn:hover {
            background: var(--accent);
            color: white;
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(255, 107, 107, 0.2);
        }

        .account-btn {
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-light) 100%);
            color: white;
            border: none;
            padding: 12px 25px;
            border-radius: 30px;
            cursor: pointer;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 10px;
            transition: var(--transition);
            box-shadow: 0 4px 10px rgba(44, 90, 160, 0.2);
        }

        .account-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 15px rgba(44, 90, 160, 0.3);
        }

        .my-questions {
            margin-top: 50px;
        }

        .my-questions h3 {
            color: var(--primary);
            margin-bottom: 25px;
            font-size: 24px;
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .questions-tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 25px;
            border-bottom: 2px solid var(--gray-light);
            padding-bottom: 10px;
        }

        .questions-tab {
            padding: 12px 25px;
            background: none;
            border: none;
            border-radius: 30px;
            cursor: pointer;
            font-weight: 600;
            color: var(--gray);
            transition: var(--transition);
        }

        .questions-tab.active {
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-light) 100%);
            color: white;
            box-shadow: 0 4px 10px rgba(44, 90, 160, 0.2);
        }

        .question-list {
            max-height: 500px;
            overflow-y: auto;
            padding-right: 10px;
        }

        .question-item {
            background-color: white;
            border-radius: var(--border-radius);
            padding: 25px;
            margin-bottom: 20px;
            box-shadow: var(--box-shadow);
            border-right: 4px solid var(--secondary);
            cursor: pointer;
            transition: var(--transition);
            border: 1px solid rgba(44, 90, 160, 0.1);
        }

        .question-item:hover {
            transform: translateY(-5px);
            box-shadow: 0 12px 25px rgba(0, 0, 0, 0.12);
        }

        .question-item.pending {
            border-right-color: #ff9f43;
        }

        .question-item.answered {
            border-right-color: var(--secondary);
        }

        .question-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 15px;
        }

        .question-title {
            font-weight: 700;
            color: var(--dark);
            font-size: 18px;
            line-height: 1.4;
        }

        .question-status {
            padding: 8px 20px;
            border-radius: 30px;
            font-size: 13px;
            font-weight: 700;
        }

        .status-pending {
            background: linear-gradient(135deg, rgba(255, 159, 67, 0.1) 0%, rgba(255, 159, 67, 0.05) 100%);
            color: #ff9f43;
        }

        .status-answered {
            background: linear-gradient(135deg, rgba(0, 168, 150, 0.1) 0%, rgba(0, 168, 150, 0.05) 100%);
            color: var(--secondary);
        }

        .question-date {
            color: var(--gray);
            font-size: 14px;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .question-content {
            color: var(--gray);
            font-size: 15px;
            line-height: 1.7;
            margin-bottom: 15px;
            overflow: hidden;
            text-overflow: ellipsis;
            display: -webkit-box;
            -webkit-line-clamp: 3;
            -webkit-box-orient: vertical;
        }

        .answer-content {
            margin-top: 20px;
            padding: 20px;
            background: linear-gradient(135deg, rgba(0, 168, 150, 0.05) 0%, rgba(0, 168, 150, 0.02) 100%);
            border-radius: var(--border-radius);
            border-right: 3px solid var(--secondary);
        }

        .answer-label {
            color: var(--secondary);
            font-weight: 700;
            margin-bottom: 10px;
            display: block;
            font-size: 15px;
        }

        .answer-text {
            color: var(--dark);
            line-height: 1.8;
            font-size: 15px;
        }

        .question-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.85);
            z-index: 2000;
            display: none;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }

        .question-modal.show {
            display: flex;
        }

        .modal-content {
            background-color: white;
            border-radius: var(--border-radius);
            width: 100%;
            max-width: 800px;
            max-height: 90vh;
            overflow-y: auto;
            position: relative;
            box-shadow: 0 25px 50px rgba(0, 0, 0, 0.25);
        }

        .modal-header {
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
            color: white;
            padding: 30px;
            border-top-right-radius: var(--border-radius);
            border-top-left-radius: var(--border-radius);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .modal-header h3 {
            font-size: 24px;
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .close-modal {
            background: none;
            border: none;
            color: white;
            font-size: 28px;
            cursor: pointer;
            transition: var(--transition);
            width: 45px;
            height: 45px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
        }

        .close-modal:hover {
            background-color: rgba(255, 255, 255, 0.15);
        }

        .modal-body {
            padding: 35px;
        }

        .modal-details {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 25px;
            margin-bottom: 35px;
        }

        @media (max-width: 768px) {
            .modal-details {
                grid-template-columns: 1fr;
            }
        }

        .modal-detail label {
            display: block;
            color: var(--gray);
            font-size: 14px;
            margin-bottom: 8px;
            font-weight: 600;
        }

        .modal-detail .value {
            font-weight: 600;
            color: var(--dark);
            font-size: 16px;
            padding: 12px 15px;
            background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
            border-radius: var(--border-radius);
            border: 1px solid var(--gray-light);
        }

        .modal-question {
            margin-bottom: 35px;
        }

        .modal-question label {
            display: block;
            color: var(--gray);
            font-size: 14px;
            margin-bottom: 12px;
            font-weight: 600;
        }

        .modal-question .value {
            background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
            padding: 25px;
            border-radius: var(--border-radius);
            line-height: 1.8;
            white-space: pre-wrap;
            border: 1px solid var(--gray-light);
            font-size: 15px;
        }

        .account-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.85);
            z-index: 2000;
            display: none;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }

        .account-modal.show {
            display: flex;
        }

        .account-modal-content {
            background-color: white;
            border-radius: var(--border-radius);
            width: 100%;
            max-width: 500px;
            box-shadow: 0 25px 50px rgba(0, 0, 0, 0.25);
        }

        .account-modal-header {
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
            color: white;
            padding: 30px;
            border-top-right-radius: var(--border-radius);
            border-top-left-radius: var(--border-radius);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .account-modal-header h3 {
            font-size: 24px;
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .success-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.85);
            z-index: 2000;
            display: none;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }

        .success-modal.show {
            display: flex;
        }

        .success-modal-content {
            background: white;
            border-radius: var(--border-radius);
            padding: 50px;
            max-width: 500px;
            width: 90%;
            text-align: center;
            box-shadow: 0 25px 50px rgba(0, 0, 0, 0.25);
        }

        .success-icon {
            width: 100px;
            height: 100px;
            background: linear-gradient(135deg, var(--secondary) 0%, var(--secondary-light) 100%);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto 30px;
            box-shadow: 0 10px 25px rgba(0, 168, 150, 0.3);
        }

        .success-icon i {
            color: white;
            font-size: 48px;
        }

        .success-modal h3 {
            color: var(--primary);
            margin-bottom: 20px;
            font-size: 28px;
        }

        .success-modal p {
            color: var(--gray);
            margin-bottom: 30px;
            line-height: 1.8;
            font-size: 16px;
        }

        .success-btn {
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-light) 100%);
            color: white;
            border: none;
            padding: 16px 40px;
            border-radius: 30px;
            font-weight: 700;
            cursor: pointer;
            font-size: 16px;
            transition: var(--transition);
            box-shadow: 0 6px 15px rgba(44, 90, 160, 0.2);
        }

        .success-btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 10px 20px rgba(44, 90, 160, 0.3);
        }

        .footer {
            background: linear-gradient(135deg, var(--primary-dark) 0%, #172a46 100%);
            color: white;
            text-align: center;
            padding: 40px 20px;
            margin-top: 70px;
            border-top: 5px solid var(--secondary);
        }

        .footer .logo {
            font-size: 28px;
            font-weight: 800;
            color: white;
            margin-bottom: 20px;
            display: block;
        }

        .footer p {
            margin-bottom: 15px;
            line-height: 1.8;
            opacity: 0.9;
        }

        .signature {
            margin-top: 30px;
            padding-top: 20px;
            border-top: 1px solid rgba(255, 255, 255, 0.1);
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 20px;
        }

        .sponsor-signature {
            font-size: 15px;
            color: rgba(255, 255, 255, 0.9);
        }

        .sponsor-signature strong {
            color: var(--secondary-light);
        }

        .designer-signature {
            font-size: 14px;
            color: rgba(255, 255, 255, 0.7);
        }

        .notification {
            position: fixed;
            top: 20px;
            left: 20px;
            right: 20px;
            padding: 20px 25px;
            border-radius: var(--border-radius);
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.15);
            z-index: 9999;
            display: flex;
            justify-content: space-between;
            align-items: center;
            transition: all 0.4s ease;
            transform: translateY(-100px);
            opacity: 0;
            border-left: 5px solid transparent;
        }

        .notification.show {
            transform: translateY(0);
            opacity: 1;
        }

        .notification.error {
            background-color: #f8d7da;
            color: #721c24;
            border-left-color: #dc3545;
        }

        .notification.success {
            background-color: #d4edda;
            color: #155724;
            border-left-color: #28a745;
        }

        .notification.info {
            background-color: #d1ecf1;
            color: #0c5460;
            border-left-color: #17a2b8;
        }

        .notification .close-notification {
            background: none;
            border: none;
            font-size: 22px;
            cursor: pointer;
            color: inherit;
            padding: 0;
            margin-right: 10px;
            opacity: 0.7;
            transition: var(--transition);
        }

        .notification .close-notification:hover {
            opacity: 1;
        }

        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, rgba(255, 255, 255, 0.95) 0%, rgba(245, 247, 251, 0.95) 100%);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 9999;
            display: none;
        }

        .loading-spinner {
            width: 60px;
            height: 60px;
            border: 5px solid var(--gray-light);
            border-top: 5px solid var(--primary);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-bottom: 25px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .loading-text {
            color: var(--primary);
            font-size: 20px;
            font-weight: 700;
        }

        .subject-selector {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
            gap: 15px;
            margin-bottom: 30px;
        }

        .subject-btn {
            padding: 15px;
            background: white;
            border: 2px solid var(--gray-light);
            border-radius: var(--border-radius);
            cursor: pointer;
            transition: var(--transition);
            text-align: center;
            font-weight: 600;
            color: var(--dark);
        }

        .subject-btn:hover {
            border-color: var(--primary-light);
            transform: translateY(-3px);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.08);
        }

        .subject-btn.active {
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-light) 100%);
            color: white;
            border-color: var(--primary);
        }

        @media (max-width: 768px) {
            .container {
                padding: 0 15px;
            }
            
            .form-card {
                padding: 25px 20px;
            }
            
            .header {
                padding: 25px 15px;
            }
            
            .header .logo {
                font-size: 26px;
            }
            
            .header .tagline {
                font-size: 16px;
            }
            
            .user-header {
                flex-direction: column;
                align-items: flex-start;
                gap: 20px;
            }
            
            .user-header .actions {
                width: 100%;
                display: flex;
                justify-content: space-between;
            }
            
            .signature {
                flex-direction: column;
                text-align: center;
                gap: 15px;
            }
            
            .modal-body {
                padding: 25px 20px;
            }
            
            .subject-selector {
                grid-template-columns: repeat(2, 1fr);
            }
        }

        @media (max-width: 480px) {
            .header .logo {
                font-size: 22px;
            }
            
            .form-card h2 {
                font-size: 22px;
            }
            
            .submit-btn {
                padding: 16px 20px;
                font-size: 16px;
            }
            
            .login-tabs {
                flex-direction: column;
            }
            
            .user-header .actions {
                flex-direction: column;
                gap: 10px;
            }
            
            .account-btn, .logout-btn {
                width: 100%;
                justify-content: center;
            }
            
            .subject-selector {
                grid-template-columns: 1fr;
            }
        }
        
        .phone-format {
            position: relative;
        }
        
        .phone-prefix {
            position: absolute;
            left: 15px;
            top: 50%;
            transform: translateY(-50%);
            color: var(--gray);
            font-weight: 600;
            background: var(--gray-light);
            padding: 2px 8px;
            border-radius: 4px;
            font-size: 14px;
            pointer-events: none;
        }
        
        .phone-input {
            padding-left: 70px !important;
        }
    </style>
</head>
<body>
    <div class="loading-overlay" id="loadingOverlay">
        <div class="loading-spinner"></div>
        <div class="loading-text">جاري التحميل...</div>
    </div>

    <header class="header">
        <div class="logo">
            <i class="fas fa-graduation-cap"></i>
            منصة عين التعليمية
        </div>
        <p class="tagline">منصة تعليمية متكاملة للإجابة على استفسارات الطلاب بكل خصوصية وسرية تامة، نضمن لك الحصول على إجابات دقيقة من خبراء متخصصين</p>
    </header>

    <div class="login-container" id="loginContainer">
        <div class="container">
            <div class="login-card">
                <div class="login-tabs">
                    <button class="login-tab active" data-tab="login">تسجيل الدخول</button>
                    <button class="login-tab" data-tab="register">إنشاء حساب</button>
                </div>
                
                <div class="login-form active" id="loginForm">
                    <h3>تسجيل الدخول</h3>
                    <form id="loginFormElement">
                        <div class="form-group">
                            <label for="loginUsername">اسم المستخدم</label>
                            <div class="input-with-icon">
                                <i class="fas fa-user"></i>
                                <input type="text" id="loginUsername" placeholder="أدخل اسم المستخدم" required>
                            </div>
                            <div class="error-message" id="loginUsernameError">الرجاء إدخال اسم المستخدم</div>
                        </div>
                        
                        <div class="form-group">
                            <label for="loginPassword">كلمة المرور</label>
                            <div class="input-with-icon">
                                <i class="fas fa-lock"></i>
                                <input type="password" id="loginPassword" placeholder="أدخل كلمة المرور" required minlength="6">
                            </div>
                            <div class="error-message" id="loginPasswordError">الرجاء إدخال كلمة مرور صحيحة</div>
                        </div>
                        
                        <button type="submit" class="submit-btn" id="loginSubmitBtn">
                            <i class="fas fa-sign-in-alt"></i>
                            تسجيل الدخول
                        </button>
                    </form>
                </div>
                
                <div class="login-form" id="registerForm">
                    <h3>إنشاء حساب جديد</h3>
                    <form id="registerFormElement">
                        <div class="form-group">
                            <label for="registerName">اسم الطالب</label>
                            <div class="input-with-icon">
                                <i class="fas fa-user"></i>
                                <input type="text" id="registerName" placeholder="أدخل اسمك الكامل" required>
                            </div>
                            <div class="error-message" id="registerNameError">الرجاء إدخال الاسم</div>
                        </div>
                        
                        <div class="form-group">
                            <label for="registerUsername">اسم المستخدم</label>
                            <div class="input-with-icon">
                                <i class="fas fa-at"></i>
                                <input type="text" id="registerUsername" placeholder="اختر اسم مستخدم" required>
                            </div>
                            <div class="error-message" id="registerUsernameError">الرجاء إدخال اسم مستخدم</div>
                            <p style="color: var(--gray); font-size: 13px; margin-top: 8px; line-height: 1.5;">ستستخدم هذا الاسم لتسجيل الدخول</p>
                        </div>
                        
                        <div class="form-group">
                            <label for="registerPassword">كلمة المرور</label>
                            <div class="input-with-icon">
                                <i class="fas fa-lock"></i>
                                <input type="password" id="registerPassword" placeholder="اختر كلمة مرور قوية" required minlength="6">
                            </div>
                            <div class="error-message" id="registerPasswordError">كلمة المرور يجب أن تكون 6 أحرف على الأقل</div>
                        </div>
                        
                        <div class="form-group">
                            <label for="registerConfirmPassword">تأكيد كلمة المرور</label>
                            <div class="input-with-icon">
                                <i class="fas fa-lock"></i>
                                <input type="password" id="registerConfirmPassword" placeholder="أعد إدخال كلمة المرور" required minlength="6">
                            </div>
                            <div class="error-message" id="registerConfirmError">كلمات المرور غير متطابقة</div>
                        </div>
                        
                        <div class="form-group">
                            <label for="registerPhone">رقم الواتساب الموريتاني (8 أرقام فقط)</label>
                            <div class="input-with-icon phone-format">
                                <div class="phone-prefix">222</div>
                                <i class="fab fa-whatsapp"></i>
                                <input type="tel" id="registerPhone" class="phone-input" placeholder="مثال: 12345678" maxlength="8" pattern="\d{8}" inputmode="numeric">
                            </div>
                            <div class="error-message" id="registerPhoneError">يجب إدخال 8 أرقام فقط (بدون مفتاح الدولة 222)</div>
                            <p style="color: var(--gray); font-size: 13px; margin-top: 8px; line-height: 1.5;">سيتم إضافة مفتاح موريتانيا (222) تلقائياً، أدخل 8 أرقام فقط</p>
                        </div>
                        
                        <button type="submit" class="submit-btn" id="registerSubmitBtn">
                            <i class="fas fa-user-plus"></i>
                            إنشاء حساب
                        </button>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <div class="student-dashboard" id="studentDashboard">
        <div class="container">
            <div class="user-header">
                <div class="user-info">
                    <div class="user-avatar" id="userAvatar">ط</div>
                    <div class="user-details">
                        <h3 id="userName">مرحباً، الطالب</h3>
                        <p id="userPhone">لم يتم إضافة رقم واتساب</p>
                    </div>
                </div>
                <div class="actions">
                    <button class="account-btn" id="accountBtn">
                        <i class="fas fa-user-cog"></i>
                        إدارة الحساب
                    </button>
                    <button class="logout-btn" id="logoutBtn">
                        <i class="fas fa-sign-out-alt"></i>
                        تسجيل خروج
                    </button>
                </div>
            </div>

            <div class="form-card">
                <h2><i class="fas fa-question-circle"></i>اطرح سؤالك</h2>
                <p class="form-subtitle">اكتب سؤالك بالتفصيل وسيقوم المشرفون بالرد عليك عبر واتساب في أقرب وقت ممكن</p>
                
                <form id="questionForm">
                    <div class="form-group">
                        <label for="questionSubject">المادة الدراسية</label>
                        <div class="input-with-icon">
                            <i class="fas fa-book"></i>
                            <select id="questionSubject" required>
                                <option value="">اختر المادة الدراسية</option>
                                <option value="رياضيات">رياضيات</option>
                                <option value="فيزياء">فيزياء</option>
                                <option value="كيمياء">كيمياء</option>
                                <option value="أحياء">أحياء</option>
                                <option value="لغة عربية">لغة عربية</option>
                                <option value="لغة إنجليزية">لغة إنجليزية</option>
                                <option value="فرنسية">فرنسية</option>
                                <option value="تاريخ">تاريخ</option>
                                <option value="جغرافيا">جغرافيا</option>
                                <option value="فلسفة">فلسفة</option>
                                <option value="علوم إسلامية">علوم إسلامية</option>
                                <option value="حاسوب">حاسوب</option>
                                <option value="أخرى">أخرى</option>
                            </select>
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label for="questionTitle">عنوان السؤال</label>
                        <div class="input-with-icon">
                            <i class="fas fa-heading"></i>
                            <input type="text" id="questionTitle" placeholder="أدخل عنواناً مختصراً يوضح سؤالك" required>
                        </div>
                        <div class="char-count" id="titleCharCount">0/100</div>
                    </div>
                    
                    <div class="form-group">
                        <label for="questionContent">نص السؤال</label>
                        <div class="input-with-icon">
                            <i class="fas fa-edit"></i>
                            <textarea id="questionContent" rows="6" placeholder="اكتب سؤالك بالتفصيل هنا... اذكر كل المعلومات المطلوبة للحصول على إجابة دقيقة" required></textarea>
                        </div>
                        <div class="char-count" id="contentCharCount">0/1500</div>
                        <div class="error-message" id="contentError">الرجاء إدخال نص السؤال</div>
                    </div>
                    
                    <div class="form-group">
                        <label for="questionWhatsapp">رقم الواتساب الموريتاني (8 أرقام فقط)</label>
                        <div class="input-with-icon phone-format">
                            <div class="phone-prefix">222</div>
                            <i class="fab fa-whatsapp"></i>
                            <input type="tel" id="questionWhatsapp" class="phone-input" placeholder="مثال: 12345678" maxlength="8" pattern="\d{8}" inputmode="numeric">
                        </div>
                        <div class="error-message" id="whatsappError">يجب إدخال 8 أرقام فقط (بدون مفتاح الدولة 222)</div>
                        <p style="color: var(--gray); font-size: 13px; margin-top: 8px; line-height: 1.5;">إذا لم تدخل رقم واتساب، سيتم استخدام الرقم المسجل في حسابك إن وجد</p>
                    </div>
                    
                    <button type="submit" class="submit-btn" id="submitBtn">
                        <i class="fas fa-paper-plane"></i>
                        إرسال السؤال
                    </button>
                </form>
                
                <div class="privacy-notice">
                    <h4><i class="fas fa-shield-alt"></i>خصوصيتك محمية</h4>
                    <p>جميع استفساراتك تبقى سرية ولا يمكن لأي طالب آخر رؤيتها. سيتم الرد على سؤالك عبر واتساب مباشرةً، ولن نشارك معلوماتك مع أي طرف ثالث. نلتزم بتقديم إجابات دقيقة من قبل مشرفين متخصصين في كل مادة دراسية.</p>
                </div>
            </div>

            <div class="my-questions">
                <h3><i class="fas fa-history"></i>أسئلتي السابقة</h3>
                
                <div class="questions-tabs">
                    <button class="questions-tab active" data-filter="all">الكل</button>
                    <button class="questions-tab" data-filter="pending">بانتظار الرد</button>
                    <button class="questions-tab" data-filter="answered">تم الرد</button>
                </div>
                
                <div class="question-list" id="questionList">
                </div>
            </div>
        </div>
    </div>

    <div class="account-modal" id="accountModal">
        <div class="account-modal-content">
            <div class="account-modal-header">
                <h3><i class="fas fa-user-cog"></i> إدارة الحساب</h3>
                <button class="close-modal" id="closeAccountModal">&times;</button>
            </div>
            <div class="modal-body">
                <form id="accountForm">
                    <div class="form-group">
                        <label for="accountName">اسم الطالب</label>
                        <div class="input-with-icon">
                            <i class="fas fa-user"></i>
                            <input type="text" id="accountName" required>
                        </div>
                        <div class="error-message" id="accountNameError">الرجاء إدخال الاسم</div>
                    </div>
                    
                    <div class="form-group">
                        <label for="accountPhone">رقم الواتساب الموريتاني (8 أرقام فقط)</label>
                        <div class="input-with-icon phone-format">
                            <div class="phone-prefix">222</div>
                            <i class="fab fa-whatsapp"></i>
                            <input type="tel" id="accountPhone" class="phone-input" placeholder="مثال: 12345678" maxlength="8" pattern="\d{8}" inputmode="numeric">
                        </div>
                        <div class="error-message" id="accountPhoneError">يجب إدخال 8 أرقام فقط (بدون مفتاح الدولة 222)</div>
                        <p style="color: var(--gray); font-size: 13px; margin-top: 8px; line-height: 1.5;">سيتم استخدام هذا الرقم للرد على أسئلتك</p>
                    </div>
                    
                    <div class="form-group">
                        <label for="accountNewPassword">تغيير كلمة المرور (اختياري)</label>
                        <div class="input-with-icon">
                            <i class="fas fa-lock"></i>
                            <input type="password" id="accountNewPassword" placeholder="كلمة المرور الجديدة (6 أحرف على الأقل)" minlength="6">
                        </div>
                        <div class="error-message" id="accountPasswordError">يجب أن تكون كلمة المرور 6 أحرف على الأقل</div>
                    </div>
                    
                    <div style="display: flex; gap: 15px; margin-top: 35px;">
                        <button type="submit" class="submit-btn" style="flex: 2;">
                            <i class="fas fa-save"></i>
                            حفظ التغييرات
                        </button>
                        <button type="button" id="cancelAccountChanges" class="logout-btn" style="flex: 1;">
                            <i class="fas fa-times"></i>
                            إلغاء
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <div class="question-modal" id="questionModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3><i class="fas fa-question-circle"></i>عرض السؤال</h3>
                <button class="close-modal" id="closeModal">&times;</button>
            </div>
            <div class="modal-body">
                <div class="modal-details">
                    <div class="modal-detail">
                        <label>المادة الدراسية</label>
                        <div class="value" id="modalSubject">-</div>
                    </div>
                    <div class="modal-detail">
                        <label>تاريخ الإرسال</label>
                        <div class="value" id="modalDate">-</div>
                    </div>
                    <div class="modal-detail">
                        <label>رقم الواتساب</label>
                        <div class="value" id="modalWhatsapp">-</div>
                    </div>
                    <div class="modal-detail">
                        <label>حالة السؤال</label>
                        <div class="value">
                            <span class="question-status" id="modalStatus">-</span>
                        </div>
                    </div>
                </div>

                <div class="modal-question">
                    <label>عنوان السؤال</label>
                    <div class="value" id="modalTitle">-</div>
                </div>

                <div class="modal-question">
                    <label>نص السؤال</label>
                    <div class="value" id="modalQuestion">-</div>
                </div>

                <div class="answer-content" id="answerSection" style="display: none;">
                    <div class="answer-label">الإجابة من المشرف:</div>
                    <div class="answer-text" id="modalAnswer">-</div>
                    <div style="margin-top: 20px; color: var(--gray); font-size: 14px;">
                        <i class="fas fa-clock"></i> تاريخ الرد: <span id="modalAnswerDate">-</span>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="success-modal" id="successModal">
        <div class="success-modal-content">
            <div class="success-icon">
                <i class="fas fa-check"></i>
            </div>
            <h3>تم استلام سؤالك بنجاح!</h3>
            <p>سوف يتم الرد عليك عبر واتساب في أقرب وقت ممكن. يمكنك تتبع حالة سؤالك من قائمة "أسئلتي السابقة". ستتلقى إشعاراً عند وصول الرد.</p>
            <button class="success-btn" id="closeSuccessModal">متابعة</button>
        </div>
    </div>

    <footer class="footer">
        <div class="container">
            <div class="logo">منصة عين التعليمية</div>
            <p>منصة تعليمية متكاملة تهدف إلى دعم الطلاب في رحلتهم التعليمية وتقديم إجابات دقيقة لاستفساراتهم</p>
            <p>جميع الحقوق محفوظة © <span id="currentYear">2024</span></p>
            
            <div class="signature">
                <div class="sponsor-signature">
                    الراعي الرسمي: <strong>med khay</strong>
                </div>
                <div class="designer-signature">
                    تصميم وتطوير: Hassen Ahmed jdoud
                </div>
            </div>
        </div>
    </footer>

    <script>
        // ==================== تهيئة Firebase ====================
        const firebaseConfig = {
            apiKey: "AIzaSyD7xmZ6lDgkxAwaVjdBetbRwOChIoe1juQ",
            authDomain: "ayn-5b88a.firebaseapp.com",
            projectId: "ayn-5b88a",
            storageBucket: "ayn-5b88a.firebasestorage.app",
            messagingSenderId: "733682854335",
            appId: "1:733682854335:web:a06b02292ac21eebb8990a"
        };

        // تهيئة Firebase مع التحقق من عدم التهيئة المزدوجة
        if (!firebase.apps.length) {
            firebase.initializeApp(firebaseConfig);
        }
        
        const auth = firebase.auth();
        const db = firebase.firestore();

        class FirebaseStudentSystem {
            constructor() {
                this.auth = auth;
                this.db = db;
                this.currentUser = null;
                this.unsubscribeQuestions = null;
                this.unsubscribeNotifications = null;
                this.authPersistence = null;
                
                this.initSystem();
            }
            
            async initSystem() {
                try {
                    await this.auth.setPersistence(firebase.auth.Auth.Persistence.LOCAL);
                    this.authPersistence = 'LOCAL';
                    console.log('تم تعيين استمرارية المصادقة إلى LOCAL');
                } catch (error) {
                    console.error('خطأ في تعيين استمرارية المصادقة:', error);
                    this.authPersistence = 'SESSION';
                }
            }
            
            getAuthErrorMessage(errorCode) {
                const messages = {
                    'auth/email-already-in-use': 'اسم المستخدم مستخدم بالفعل',
                    'auth/invalid-email': 'اسم المستخدم غير صالح',
                    'auth/operation-not-allowed': 'عملية التسجيل غير مسموحة',
                    'auth/weak-password': 'كلمة المرور ضعيفة',
                    'auth/user-disabled': 'هذا الحساب معطل',
                    'auth/user-not-found': 'اسم المستخدم غير موجود',
                    'auth/wrong-password': 'كلمة المرور غير صحيحة',
                    'auth/too-many-requests': 'تم تجاوز عدد المحاولات، حاول لاحقاً',
                    'auth/network-request-failed': 'فشل الاتصال بالشبكة، تحقق من اتصالك بالإنترنت'
                };
                return messages[errorCode] || 'حدث خطأ غير متوقع';
            }
            
            usernameToEmail(username) {
                let email = username.trim().toLowerCase();
                email = email.replace(/\s+/g, '.');
                email = email.replace(/[^a-zA-Z0-9._-]/g, '');
                return email + '@ayn.student';
            }
            
            formatMauritanianPhone(phoneDigits) {
                if (!phoneDigits) return '';
                if (phoneDigits.length !== 8) return '';
                return `222${phoneDigits}`;
            }
            
            validatePhoneDigits(phoneDigits) {
                if (!phoneDigits) return true;
                if (phoneDigits.length !== 8) return false;
                const phoneRegex = /^\d{8}$/;
                return phoneRegex.test(phoneDigits);
            }
            
            async registerStudent(name, username, password, phoneDigits = '') {
                try {
                    if (!navigator.onLine) {
                        return { success: false, message: 'لا يوجد اتصال بالإنترنت' };
                    }
                    
                    if (phoneDigits && !this.validatePhoneDigits(phoneDigits)) {
                        return { 
                            success: false, 
                            message: 'يجب إدخال 8 أرقام فقط لرقم الواتساب' 
                        };
                    }
                    
                    const email = this.usernameToEmail(username);
                    const userCredential = await this.auth.createUserWithEmailAndPassword(email, password);
                    const user = userCredential.user;
                    
                    const formattedPhone = this.formatMauritanianPhone(phoneDigits);
                    
                    await this.db.collection('users').doc(user.uid).set({
                        name: name,
                        username: username,
                        email: email,
                        phone: formattedPhone,
                        phoneDigits: phoneDigits,
                        role: 'student',
                        createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                        lastLogin: firebase.firestore.FieldValue.serverTimestamp()
                    });
                    
                    this.currentUser = { 
                        uid: user.uid, 
                        name, 
                        username, 
                        email, 
                        phone: formattedPhone,
                        phoneDigits: phoneDigits,
                        role: 'student',
                        updatePassword: function(password) {
                            return user.updatePassword(password);
                        }
                    };
                    
                    return { success: true, user: this.currentUser };
                } catch (error) {
                    console.error('خطأ في التسجيل:', error);
                    return { 
                        success: false, 
                        message: this.getAuthErrorMessage(error.code) || error.message 
                    };
                }
            }
            
            async loginStudent(username, password) {
                try {
                    if (!navigator.onLine) {
                        return { success: false, message: 'لا يوجد اتصال بالإنترنت' };
                    }
                    
                    const email = this.usernameToEmail(username);
                    const userCredential = await this.auth.signInWithEmailAndPassword(email, password);
                    const user = userCredential.user;
                    
                    await this.db.collection('users').doc(user.uid).update({
                        lastLogin: firebase.firestore.FieldValue.serverTimestamp()
                    });
                    
                    const userDoc = await this.db.collection('users').doc(user.uid).get();
                    const userData = userDoc.data();
                    
                    this.currentUser = { 
                        uid: user.uid, 
                        ...userData,
                        updatePassword: function(password) {
                            return user.updatePassword(password);
                        }
                    };
                    
                    return { success: true, user: this.currentUser };
                } catch (error) {
                    console.error('خطأ في تسجيل الدخول:', error);
                    return { 
                        success: false, 
                        message: this.getAuthErrorMessage(error.code) || error.message 
                    };
                }
            }
            
            async logoutStudent() {
                try {
                    if (this.unsubscribeQuestions) {
                        this.unsubscribeQuestions();
                        this.unsubscribeQuestions = null;
                    }
                    if (this.unsubscribeNotifications) {
                        this.unsubscribeNotifications();
                        this.unsubscribeNotifications = null;
                    }
                    
                    await this.auth.signOut();
                    this.currentUser = null;
                    
                    return { success: true };
                } catch (error) {
                    console.error('خطأ في تسجيل الخروج:', error);
                    return { success: false, message: error.message };
                }
            }
            
            async updateStudent(updates) {
                try {
                    if (!this.currentUser) throw new Error('لم يتم تسجيل الدخول');
                    
                    if (updates.phoneDigits && !this.validatePhoneDigits(updates.phoneDigits)) {
                        return { 
                            success: false, 
                            message: 'يجب إدخال 8 أرقام فقط لرقم الواتساب' 
                        };
                    }
                    
                    const user = this.auth.currentUser;
                    
                    if (updates.password && user) {
                        await user.updatePassword(updates.password);
                        delete updates.password;
                    }
                    
                    if (updates.phoneDigits) {
                        updates.phone = this.formatMauritanianPhone(updates.phoneDigits);
                    }
                    
                    await this.db.collection('users').doc(this.currentUser.uid).update(updates);
                    
                    this.currentUser = { ...this.currentUser, ...updates };
                    
                    return { success: true, user: this.currentUser };
                } catch (error) {
                    console.error('خطأ في تحديث بيانات الطالب:', error);
                    return { success: false, message: error.message };
                }
            }
            
            async submitQuestion(subject, title, content, whatsappDigits = '') {
                try {
                    if (!this.currentUser) throw new Error('لم يتم تسجيل الدخول');
                    
                    if (!navigator.onLine) {
                        return { success: false, message: 'لا يوجد اتصال بالإنترنت' };
                    }
                    
                    if (whatsappDigits && !this.validatePhoneDigits(whatsappDigits)) {
                        return { 
                            success: false, 
                            message: 'يجب إدخال 8 أرقام فقط لرقم الواتساب' 
                        };
                    }
                    
                    const finalWhatsappDigits = whatsappDigits || this.currentUser.phoneDigits || '';
                    const finalWhatsapp = this.formatMauritanianPhone(finalWhatsappDigits);
                    
                    if (!finalWhatsapp) {
                        return {
                            success: false,
                            message: 'الرجاء إدخال رقم واتساب موريتاني للإجابة على سؤالك'
                        };
                    }
                    
                    const questionData = {
                        userId: this.currentUser.uid,
                        userName: this.currentUser.name,
                        userPhone: finalWhatsapp,
                        userPhoneDigits: finalWhatsappDigits,
                        subject: subject,
                        title: title || '',
                        question: content,
                        answer: '',
                        status: 'pending',
                        createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                        answeredAt: null
                    };
                    
                    const questionRef = await this.db.collection('questions').add(questionData);
                    
                    await this.db.collection('notifications').add({
                        userId: this.currentUser.uid,
                        title: 'سؤال جديد',
                        message: `سؤال جديد من ${this.currentUser.name} في مادة ${subject}`,
                        read: false,
                        timestamp: firebase.firestore.FieldValue.serverTimestamp(),
                        type: 'admin'
                    });
                    
                    return { 
                        success: true, 
                        questionId: questionRef.id, 
                        question: questionData 
                    };
                } catch (error) {
                    console.error('خطأ في إرسال السؤال:', error);
                    return { 
                        success: false, 
                        message: `حدث خطأ: ${error.message}` 
                    };
                }
            }
            
            async getStudentQuestions() {
                try {
                    if (!this.currentUser) throw new Error('لم يتم تسجيل الدخول');
                    
                    const snapshot = await this.db.collection('questions')
                        .where('userId', '==', this.currentUser.uid)
                        .orderBy('createdAt', 'desc')
                        .get();
                    
                    return snapshot.docs.map(doc => ({
                        id: doc.id,
                        ...doc.data()
                    }));
                } catch (error) {
                    console.error('خطأ في جلب أسئلة الطالب:', error);
                    return [];
                }
            }
            
            async getQuestionById(questionId) {
                try {
                    const doc = await this.db.collection('questions').doc(questionId).get();
                    if (doc.exists) {
                        const question = { id: doc.id, ...doc.data() };
                        
                        if (question.userId !== this.currentUser?.uid) {
                            throw new Error('ليس لديك صلاحية لعرض هذا السؤال');
                        }
                        
                        return question;
                    }
                    return null;
                } catch (error) {
                    console.error('خطأ في جلب السؤال:', error);
                    throw error;
                }
            }
            
            setupQuestionsListener(callback) {
                if (!this.currentUser) return null;
                
                if (this.unsubscribeQuestions) {
                    this.unsubscribeQuestions();
                }
                
                this.unsubscribeQuestions = this.db.collection('questions')
                    .where('userId', '==', this.currentUser.uid)
                    .orderBy('createdAt', 'desc')
                    .onSnapshot(snapshot => {
                        const questions = snapshot.docs.map(doc => ({
                            id: doc.id,
                            ...doc.data()
                        }));
                        callback(questions);
                    }, error => {
                        console.error('خطأ في مستمع الأسئلة:', error);
                    });
                    
                return this.unsubscribeQuestions;
            }
            
            setupNotificationsListener(callback) {
                if (!this.currentUser) return null;
                
                if (this.unsubscribeNotifications) {
                    this.unsubscribeNotifications();
                }
                
                this.unsubscribeNotifications = this.db.collection('notifications')
                    .where('userId', '==', this.currentUser.uid)
                    .orderBy('timestamp', 'desc')
                    .limit(10)
                    .onSnapshot(snapshot => {
                        const notifications = snapshot.docs.map(doc => ({
                            id: doc.id,
                            ...doc.data()
                        }));
                        callback(notifications);
                    }, error => {
                        console.error('خطأ في مستمع الإشعارات:', error);
                    });
                    
                return this.unsubscribeNotifications;
            }
            
            async markNotificationAsRead(notificationId) {
                try {
                    await this.db.collection('notifications').doc(notificationId).update({
                        read: true
                    });
                    return { success: true };
                } catch (error) {
                    console.error('خطأ في تحديث الإشعار:', error);
                    return { success: false, message: error.message };
                }
            }
        }

        const studentSystem = new FirebaseStudentSystem();

        // ==================== دوال المساعدة ====================
        function showLoading() {
            document.getElementById('loadingOverlay').style.display = 'flex';
        }
        
        function hideLoading() {
            document.getElementById('loadingOverlay').style.display = 'none';
        }
        
        function showNotification(title, message, type = 'info') {
            const notification = document.createElement('div');
            notification.className = `notification ${type}`;
            
            notification.innerHTML = `
                <div>
                    <strong style="display: block; margin-bottom: 5px;">${title}</strong>
                    <div>${message}</div>
                </div>
                <button class="close-notification">&times;</button>
            `;
            
            document.body.appendChild(notification);
            
            setTimeout(() => {
                notification.classList.add('show');
            }, 10);
            
            const autoRemove = setTimeout(() => {
                notification.classList.remove('show');
                setTimeout(() => {
                    if (notification.parentNode) {
                        notification.parentNode.removeChild(notification);
                    }
                }, 300);
            }, 5000);
            
            notification.querySelector('.close-notification').addEventListener('click', () => {
                clearTimeout(autoRemove);
                notification.classList.remove('show');
                setTimeout(() => {
                    if (notification.parentNode) {
                        notification.parentNode.removeChild(notification);
                    }
                }, 300);
            });
            
            notification.addEventListener('click', (e) => {
                if (!e.target.classList.contains('close-notification')) {
                    clearTimeout(autoRemove);
                    notification.classList.remove('show');
                    setTimeout(() => {
                        if (notification.parentNode) {
                            notification.parentNode.removeChild(notification);
                        }
                    }, 300);
                }
            });
        }
        
        async function checkAuthState() {
            return new Promise((resolve) => {
                auth.onAuthStateChanged(async (user) => {
                    console.log('حالة المصادقة:', user ? 'تم تسجيل الدخول' : 'لم يتم تسجيل الدخول');
                    
                    if (user) {
                        showLoading();
                        try {
                            const userDoc = await db.collection('users').doc(user.uid).get();
                            if (userDoc.exists && userDoc.data().role === 'student') {
                                studentSystem.currentUser = { 
                                    uid: user.uid, 
                                    ...userDoc.data(),
                                    updatePassword: function(password) {
                                        return user.updatePassword(password);
                                    }
                                };
                                await showStudentDashboard();
                            } else {
                                await auth.signOut();
                                studentSystem.currentUser = null;
                                showLoginScreen();
                            }
                        } catch (error) {
                            console.error('خطأ في التحقق من حالة المستخدم:', error);
                            showLoginScreen();
                        } finally {
                            hideLoading();
                            resolve();
                        }
                    } else {
                        studentSystem.currentUser = null;
                        showLoginScreen();
                        hideLoading();
                        resolve();
                    }
                });
            });
        }
        
        function showLoginScreen() {
            document.getElementById('loginContainer').classList.add('active');
            document.getElementById('studentDashboard').classList.remove('active');
        }
        
        async function showStudentDashboard() {
            document.getElementById('loginContainer').classList.remove('active');
            document.getElementById('studentDashboard').classList.add('active');
            updateUserInfo();
            loadUserQuestions();
            startRealTimeListeners();
            
            // حفظ حالة الدخول في localStorage
            localStorage.setItem('ayn_last_login', new Date().toISOString());
        }
        
        function updateUserInfo() {
            if (!studentSystem.currentUser) return;
            
            document.getElementById('userName').textContent = `مرحباً، ${studentSystem.currentUser.name}`;
            
            if (studentSystem.currentUser.phone) {
                document.getElementById('userPhone').textContent = `رقم الواتساب: ${studentSystem.currentUser.phone}`;
            } else {
                document.getElementById('userPhone').textContent = 'لم يتم إضافة رقم واتساب';
            }
            
            const userAvatar = document.getElementById('userAvatar');
            userAvatar.textContent = studentSystem.currentUser.name.charAt(0).toUpperCase();
        }
        
        async function loadUserQuestions(filter = 'all') {
            try {
                const questions = await studentSystem.getStudentQuestions();
                renderQuestionsList(questions, filter);
            } catch (error) {
                console.error('خطأ في تحميل الأسئلة:', error);
            }
        }
        
        function renderQuestionsList(questions, filter = 'all') {
            const questionList = document.getElementById('questionList');
            
            if (filter !== 'all') {
                questions = questions.filter(q => q.status === filter);
            }
            
            if (questions.length === 0) {
                questionList.innerHTML = `
                    <div style="text-align: center; padding: 40px; color: var(--gray);">
                        <i class="fas fa-inbox" style="font-size: 48px; margin-bottom: 15px; opacity: 0.5;"></i>
                        <p>لا توجد أسئلة ${filter !== 'all' ? 'في هذه القائمة' : 'بعد'}</p>
                    </div>
                `;
                return;
            }
            
            questionList.innerHTML = '';
            
            questions.forEach(question => {
                const questionItem = document.createElement('div');
                questionItem.className = `question-item ${question.status}`;
                questionItem.dataset.id = question.id;
                
                const date = question.createdAt ? new Date(question.createdAt.toDate ? question.createdAt.toDate() : question.createdAt) : new Date();
                const dateString = date.toLocaleDateString('ar-SA');
                const timeString = date.toLocaleTimeString('ar-SA', { hour: '2-digit', minute: '2-digit' });
                
                const statusText = question.status === 'pending' ? 'بانتظار الرد' : 'تم الرد';
                const statusClass = question.status === 'pending' ? 'status-pending' : 'status-answered';
                
                questionItem.innerHTML = `
                    <div class="question-header">
                        <div class="question-title">${question.title || 'بدون عنوان'}</div>
                        <div class="question-status ${statusClass}">${statusText}</div>
                    </div>
                    <div class="question-date">
                        <i class="fas fa-calendar"></i> ${dateString} - ${timeString}
                        <span style="margin-right: 15px;">|</span>
                        <i class="fas fa-book"></i> ${question.subject}
                    </div>
                    <div class="question-content">${question.question.substring(0, 200)}${question.question.length > 200 ? '...' : ''}</div>
                    ${question.answer ? `
                        <div class="answer-content">
                            <div class="answer-label">الإجابة:</div>
                            <div class="answer-text">${question.answer.substring(0, 150)}${question.answer.length > 150 ? '...' : ''}</div>
                        </div>
                    ` : ''}
                `;
                
                questionItem.addEventListener('click', () => {
                    openQuestionModal(question.id);
                });
                
                questionList.appendChild(questionItem);
            });
        }
        
        async function openQuestionModal(questionId) {
            try {
                showLoading();
                const question = await studentSystem.getQuestionById(questionId);
                
                const date = question.createdAt ? new Date(question.createdAt.toDate ? question.createdAt.toDate() : question.createdAt) : new Date();
                const dateString = date.toLocaleDateString('ar-SA', { 
                    year: 'numeric', 
                    month: 'long', 
                    day: 'numeric',
                    weekday: 'long'
                });
                const timeString = date.toLocaleTimeString('ar-SA', { hour: '2-digit', minute: '2-digit' });
                
                document.getElementById('modalDate').textContent = `${dateString} - ${timeString}`;
                document.getElementById('modalSubject').textContent = question.subject;
                document.getElementById('modalWhatsapp').textContent = question.userPhone || 'لم يتم إضافة رقم';
                document.getElementById('modalStatus').textContent = question.status === 'pending' ? 'بانتظار الرد' : 'تم الرد';
                document.getElementById('modalStatus').className = `question-status ${question.status === 'pending' ? 'status-pending' : 'status-answered'}`;
                document.getElementById('modalTitle').textContent = question.title || 'بدون عنوان';
                document.getElementById('modalQuestion').textContent = question.question;
                
                const answerSection = document.getElementById('answerSection');
                if (question.answer) {
                    answerSection.style.display = 'block';
                    document.getElementById('modalAnswer').textContent = question.answer;
                    
                    const answerDate = question.answeredAt ? new Date(question.answeredAt.toDate ? question.answeredAt.toDate() : question.answeredAt) : date;
                    const answerDateString = answerDate.toLocaleDateString('ar-SA');
                    const answerTimeString = answerDate.toLocaleTimeString('ar-SA', { hour: '2-digit', minute: '2-digit' });
                    document.getElementById('modalAnswerDate').textContent = `${answerDateString} - ${answerTimeString}`;
                } else {
                    answerSection.style.display = 'none';
                }
                
                document.getElementById('questionModal').classList.add('show');
                hideLoading();
            } catch (error) {
                hideLoading();
                showNotification('خطأ', error.message, 'error');
            }
        }
        
        function startRealTimeListeners() {
            studentSystem.setupQuestionsListener(questions => {
                const activeFilter = document.querySelector('.questions-tab.active')?.dataset.filter || 'all';
                renderQuestionsList(questions, activeFilter);
            });
            
            studentSystem.setupNotificationsListener(notifications => {
                notifications.forEach(notification => {
                    if (!notification.read) {
                        showNotification(notification.title, notification.message, 'success');
                        studentSystem.markNotificationAsRead(notification.id);
                    }
                });
            });
        }

        // ==================== تهيئة الصفحة ====================
        document.addEventListener('DOMContentLoaded', async function() {
            document.getElementById('currentYear').textContent = new Date().getFullYear();
            
            showLoading();
            
            // التحقق من آخر دخول
            const lastLogin = localStorage.getItem('ayn_last_login');
            if (lastLogin) {
                const lastLoginDate = new Date(lastLogin);
                const now = new Date();
                const hoursDiff = Math.abs(now - lastLoginDate) / 36e5;
                
                // إذا مرت أكثر من 24 ساعة منذ آخر دخول، نطلب إعادة تسجيل الدخول
                if (hoursDiff > 24) {
                    localStorage.removeItem('ayn_last_login');
                    await auth.signOut();
                }
            }
            
            await checkAuthState();
            
            document.getElementById('questionTitle').addEventListener('input', function() {
                const length = this.value.length;
                document.getElementById('titleCharCount').textContent = `${length}/100`;
                if (length > 100) {
                    document.getElementById('titleCharCount').classList.add('warning');
                    this.classList.add('error');
                } else {
                    document.getElementById('titleCharCount').classList.remove('warning');
                    this.classList.remove('error');
                }
            });
            
            document.getElementById('questionContent').addEventListener('input', function() {
                const length = this.value.length;
                document.getElementById('contentCharCount').textContent = `${length}/1500`;
                if (length > 1500) {
                    document.getElementById('contentCharCount').classList.add('warning');
                    this.classList.add('error');
                } else {
                    document.getElementById('contentCharCount').classList.remove('warning');
                    this.classList.remove('error');
                }
            });
            
            // تقييد إدخال الأرقام فقط في حقول الهواتف
            document.querySelectorAll('.phone-input').forEach(input => {
                input.addEventListener('input', function() {
                    this.value = this.value.replace(/[^\d]/g, '').substring(0, 8);
                });
                
                input.addEventListener('keydown', function(e) {
                    if (!/[0-9]|Backspace|Delete|Tab|ArrowLeft|ArrowRight/.test(e.key)) {
                        e.preventDefault();
                    }
                });
            });
            
            document.getElementById('loginFormElement').addEventListener('submit', async function(e) {
                e.preventDefault();
                
                const username = document.getElementById('loginUsername').value.trim();
                const password = document.getElementById('loginPassword').value;
                
                document.querySelectorAll('#loginForm .error-message').forEach(el => {
                    el.style.display = 'none';
                });
                
                let hasError = false;
                
                if (!username) {
                    document.getElementById('loginUsernameError').textContent = 'الرجاء إدخال اسم المستخدم';
                    document.getElementById('loginUsernameError').style.display = 'block';
                    hasError = true;
                }
                
                if (!password) {
                    document.getElementById('loginPasswordError').textContent = 'الرجاء إدخال كلمة المرور';
                    document.getElementById('loginPasswordError').style.display = 'block';
                    hasError = true;
                } else if (password.length < 6) {
                    document.getElementById('loginPasswordError').textContent = 'كلمة المرور يجب أن تكون 6 أحرف على الأقل';
                    document.getElementById('loginPasswordError').style.display = 'block';
                    hasError = true;
                }
                
                if (hasError) {
                    showNotification('خطأ في تسجيل الدخول', 'الرجاء تصحيح الأخطاء في النموذج', 'error');
                    return;
                }
                
                const submitBtn = document.getElementById('loginSubmitBtn');
                const originalText = submitBtn.innerHTML;
                
                submitBtn.disabled = true;
                submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> جاري تسجيل الدخول...';
                
                const result = await studentSystem.loginStudent(username, password);
                
                if (result.success) {
                    showNotification('نجاح', 'تم تسجيل الدخول بنجاح', 'success');
                    await showStudentDashboard();
                } else {
                    showNotification('خطأ', result.message, 'error');
                }
                
                submitBtn.disabled = false;
                submitBtn.innerHTML = originalText;
            });
            
            document.getElementById('registerFormElement').addEventListener('submit', async function(e) {
                e.preventDefault();
                
                const name = document.getElementById('registerName').value.trim();
                const username = document.getElementById('registerUsername').value.trim();
                const password = document.getElementById('registerPassword').value;
                const confirmPassword = document.getElementById('registerConfirmPassword').value;
                const phoneDigits = document.getElementById('registerPhone').value.trim();
                
                document.querySelectorAll('#registerForm .error-message').forEach(el => {
                    el.style.display = 'none';
                });
                
                let hasError = false;
                
                if (!name) {
                    document.getElementById('registerNameError').textContent = 'الرجاء إدخال الاسم';
                    document.getElementById('registerNameError').style.display = 'block';
                    hasError = true;
                }
                
                if (!username) {
                    document.getElementById('registerUsernameError').textContent = 'الرجاء إدخال اسم المستخدم';
                    document.getElementById('registerUsernameError').style.display = 'block';
                    hasError = true;
                }
                
                if (!password) {
                    document.getElementById('registerPasswordError').textContent = 'الرجاء إدخال كلمة المرور';
                    document.getElementById('registerPasswordError').style.display = 'block';
                    hasError = true;
                } else if (password.length < 6) {
                    document.getElementById('registerPasswordError').textContent = 'كلمة المرور يجب أن تكون 6 أحرف على الأقل';
                    document.getElementById('registerPasswordError').style.display = 'block';
                    hasError = true;
                }
                
                if (!confirmPassword) {
                    document.getElementById('registerConfirmError').textContent = 'الرجاء تأكيد كلمة المرور';
                    document.getElementById('registerConfirmError').style.display = 'block';
                    hasError = true;
                } else if (password !== confirmPassword) {
                    document.getElementById('registerConfirmError').textContent = 'كلمات المرور غير متطابقة';
                    document.getElementById('registerConfirmError').style.display = 'block';
                    hasError = true;
                }
                
                if (phoneDigits && !studentSystem.validatePhoneDigits(phoneDigits)) {
                    document.getElementById('registerPhoneError').textContent = 'يجب إدخال 8 أرقام فقط لرقم الواتساب';
                    document.getElementById('registerPhoneError').style.display = 'block';
                    hasError = true;
                }
                
                if (hasError) {
                    showNotification('خطأ في التسجيل', 'الرجاء تصحيح الأخطاء في النموذج', 'error');
                    return;
                }
                
                const submitBtn = document.getElementById('registerSubmitBtn');
                const originalText = submitBtn.innerHTML;
                
                submitBtn.disabled = true;
                submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> جاري إنشاء الحساب...';
                
                const result = await studentSystem.registerStudent(name, username, password, phoneDigits);
                
                if (result.success) {
                    showNotification('نجاح', 'تم إنشاء الحساب بنجاح', 'success');
                    document.getElementById('registerFormElement').reset();
                    
                    setTimeout(async () => {
                        const loginResult = await studentSystem.loginStudent(username, password);
                        if (loginResult.success) {
                            showNotification('تم التسجيل', 'تم تسجيل دخولك تلقائياً', 'success');
                            await showStudentDashboard();
                        } else {
                            document.querySelector('[data-tab="login"]').click();
                            document.getElementById('loginUsername').value = username;
                            document.getElementById('loginPassword').value = password;
                        }
                    }, 1000);
                } else {
                    showNotification('خطأ', result.message, 'error');
                }
                
                submitBtn.disabled = false;
                submitBtn.innerHTML = originalText;
            });
            
            document.getElementById('questionForm').addEventListener('submit', async function(e) {
                e.preventDefault();
                
                if (!studentSystem.currentUser) {
                    showNotification('خطأ', 'الرجاء تسجيل الدخول أولاً', 'error');
                    return;
                }
                
                const subject = document.getElementById('questionSubject').value;
                const title = document.getElementById('questionTitle').value.trim();
                const whatsappDigits = document.getElementById('questionWhatsapp').value.trim();
                const question = document.getElementById('questionContent').value.trim();
                
                if (!subject) {
                    showNotification('خطأ', 'الرجاء اختيار المادة الدراسية', 'error');
                    return;
                }
                
                if (!question) {
                    document.getElementById('contentError').textContent = 'الرجاء كتابة نص السؤال';
                    document.getElementById('contentError').style.display = 'block';
                    document.getElementById('questionContent').classList.add('error');
                    showNotification('خطأ', 'الرجاء كتابة نص السؤال', 'error');
                    return;
                }
                
                if (whatsappDigits && !studentSystem.validatePhoneDigits(whatsappDigits)) {
                    document.getElementById('whatsappError').textContent = 'يجب إدخال 8 أرقام فقط لرقم الواتساب';
                    document.getElementById('whatsappError').style.display = 'block';
                    document.getElementById('questionWhatsapp').classList.add('error');
                    showNotification('خطأ', 'يجب إدخال 8 أرقام فقط لرقم الواتساب', 'error');
                    return;
                }
                
                const submitBtn = document.getElementById('submitBtn');
                const originalText = submitBtn.innerHTML;
                
                submitBtn.disabled = true;
                submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> جاري الإرسال...';
                
                const result = await studentSystem.submitQuestion(subject, title, question, whatsappDigits);
                
                if (result.success) {
                    document.getElementById('successModal').classList.add('show');
                    
                    document.getElementById('questionForm').reset();
                    document.getElementById('titleCharCount').textContent = '0/100';
                    document.getElementById('contentCharCount').textContent = '0/1500';
                    document.getElementById('contentError').style.display = 'none';
                    document.getElementById('whatsappError').style.display = 'none';
                    document.getElementById('questionContent').classList.remove('error');
                    document.getElementById('questionWhatsapp').classList.remove('error');
                    
                    const activeFilter = document.querySelector('.questions-tab.active').dataset.filter;
                    await loadUserQuestions(activeFilter);
                } else {
                    showNotification('خطأ', result.message, 'error');
                }
                
                submitBtn.disabled = false;
                submitBtn.innerHTML = originalText;
            });
            
            document.getElementById('accountBtn').addEventListener('click', function() {
                if (!studentSystem.currentUser) return;
                
                document.getElementById('accountName').value = studentSystem.currentUser.name;
                document.getElementById('accountPhone').value = studentSystem.currentUser.phoneDigits || '';
                document.getElementById('accountNewPassword').value = '';
                document.getElementById('accountModal').classList.add('show');
            });
            
            document.getElementById('accountForm').addEventListener('submit', async function(e) {
                e.preventDefault();
                
                const name = document.getElementById('accountName').value.trim();
                const phoneDigits = document.getElementById('accountPhone').value.trim();
                const newPassword = document.getElementById('accountNewPassword').value;
                
                const updates = { name, phoneDigits };
                if (newPassword) {
                    updates.password = newPassword;
                }
                
                const result = await studentSystem.updateStudent(updates);
                
                if (result.success) {
                    showNotification('نجاح', 'تم تحديث بيانات الحساب', 'success');
                    document.getElementById('accountModal').classList.remove('show');
                    updateUserInfo();
                } else {
                    showNotification('خطأ', result.message, 'error');
                }
            });
            
            document.getElementById('logoutBtn').addEventListener('click', async function() {
                if (confirm('هل أنت متأكد من تسجيل الخروج؟')) {
                    const result = await studentSystem.logoutStudent();
                    
                    if (result.success) {
                        localStorage.removeItem('ayn_last_login');
                        document.getElementById('studentDashboard').classList.remove('active');
                        document.getElementById('loginContainer').classList.add('active');
                        document.getElementById('loginUsername').value = '';
                        document.getElementById('loginPassword').value = '';
                        showNotification('تم', 'تم تسجيل خروجك بنجاح', 'info');
                    }
                }
            });
            
            document.querySelectorAll('.login-tab').forEach(tab => {
                tab.addEventListener('click', function() {
                    const tabName = this.dataset.tab;
                    
                    document.querySelectorAll('.login-tab').forEach(t => t.classList.remove('active'));
                    document.querySelectorAll('.login-form').forEach(f => f.classList.remove('active'));
                    
                    this.classList.add('active');
                    document.getElementById(tabName + 'Form').classList.add('active');
                });
            });
            
            document.querySelectorAll('.questions-tab').forEach(tab => {
                tab.addEventListener('click', function() {
                    document.querySelectorAll('.questions-tab').forEach(t => t.classList.remove('active'));
                    this.classList.add('active');
                    loadUserQuestions(this.dataset.filter);
                });
            });
            
            document.getElementById('closeAccountModal').addEventListener('click', function() {
                document.getElementById('accountModal').classList.remove('show');
            });
            
            document.getElementById('cancelAccountChanges').addEventListener('click', function() {
                document.getElementById('accountModal').classList.remove('show');
            });
            
            document.getElementById('closeSuccessModal').addEventListener('click', function() {
                document.getElementById('successModal').classList.remove('show');
            });
            
            document.getElementById('closeModal').addEventListener('click', function() {
                document.getElementById('questionModal').classList.remove('show');
            });
            
            document.getElementById('questionModal').addEventListener('click', function(e) {
                if (e.target === this) {
                    this.classList.remove('show');
                }
            });
            
            document.getElementById('loginPassword')?.addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    document.getElementById('loginSubmitBtn').click();
                }
            });
            
            // استعادة الجلسة عند تحديث الصفحة
            window.addEventListener('beforeunload', function() {
                if (studentSystem.currentUser) {
                    localStorage.setItem('ayn_last_login', new Date().toISOString());
                }
            });
            
            // إعادة تحميل البيانات عند الرجوع للصفحة
            window.addEventListener('pageshow', function(event) {
                if (event.persisted) {
                    location.reload();
                }
            });
            
            // منع التخزين المؤقت للصفحة
            if ('serviceWorker' in navigator) {
                navigator.serviceWorker.getRegistrations().then(function(registrations) {
                    for(let registration of registrations) {
                        registration.unregister();
                    }
                });
            }
        });
    </script>
</body>
    </html>
